<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>locations.js.coffee</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>locations.js.coffee</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nv">Bookshelf = </span><span class="nf">(args) -&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>Elements</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nv">availableBookshelves = </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#assignedBookshelves&#39;</span><span class="p">)</span>
  <span class="nv">map = </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#locationMap&#39;</span><span class="p">)</span>
  <span class="nv">bookshelfJSONId = </span><span class="s1">&#39;#bookshelf_location_json&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Functions</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nv">handleClick = </span><span class="nf">(event) -&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;handling click&#39;</span><span class="p">)</span>
    <span class="nv">elm = </span><span class="nx">$</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">elm</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;bookshelfName&#39;</span><span class="p">)</span>
      <span class="nv">bookshelfId = </span><span class="nx">elm</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-bookshelf_id&#39;</span><span class="p">)</span>
      <span class="nx">initPlacementBox</span><span class="p">(</span><span class="nx">bookshelfId</span><span class="p">)</span>


  <span class="nv">initPlacementBox = </span><span class="nf">(bookshelfId, coords) -&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>If the bookshelves box is already present, do nothing.
Determine this using data-bookshelf_id</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">boxId = </span><span class="s1">&#39;#bookshelfPlacementBox-&#39;</span> <span class="o">+</span> <span class="nx">bookshelfId</span>
    <span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="nx">boxId</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;out there&#39;</span><span class="p">)</span>
      <span class="k">return</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>TODO: add bookshelf name to box
Add the bookshelf placement div to the map</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">placementBox = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">)</span>
    <span class="nv">placementBox.id = </span><span class="nx">boxId</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/#/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nv">placementBox.className = </span><span class="s1">&#39;placementBox&#39;</span>
    <span class="nx">placementBox</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;data-bookshelf_id&#39;</span><span class="p">,</span> <span class="nx">bookshelfId</span><span class="p">)</span>
    <span class="nx">map</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">placementBox</span><span class="p">)</span>

    <span class="nx">$</span><span class="p">(</span><span class="nx">boxId</span><span class="p">).</span><span class="nx">draggable</span><span class="p">({</span>
      <span class="nv">containment: </span><span class="nx">map</span>
      <span class="nv">stop: </span><span class="nx">recordPosition</span>
    <span class="p">})</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">boxId</span><span class="p">).</span><span class="nx">resizable</span><span class="p">({</span>
      <span class="nv">stop: </span><span class="nx">recordPosition</span>
    <span class="p">})</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>TODO: if coords are passed in, do a bunch of math and position the box
console.log($(boxId).position())</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nv">recordPosition = </span><span class="nf">(event, elm) -&gt;</span>
    <span class="nv">bookshelfId = </span><span class="nx">elm</span><span class="p">.</span><span class="nx">helper</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-bookshelf_id&#39;</span><span class="p">)</span>
    <span class="nv">elmWidth = </span><span class="nx">elm</span><span class="p">.</span><span class="nx">helper</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">offsetWidth</span>
    <span class="nv">elmHeight = </span><span class="nx">elm</span><span class="p">.</span><span class="nx">helper</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">offsetHeight</span>

    <span class="nv">x1 = </span><span class="nx">elm</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">left</span>
    <span class="nv">y1 = </span><span class="nx">elm</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">top</span>
    <span class="nv">x2 = </span><span class="nx">x1</span> <span class="o">+</span> <span class="nx">elmWidth</span>
    <span class="nv">y2 = </span><span class="nx">y1</span> <span class="o">+</span> <span class="nx">elmHeight</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>Assume json will always be present</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">bookshelfCoords = </span><span class="nx">jQuery</span><span class="p">.</span><span class="nx">parseJSON</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">bookshelfJSONId</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">)</span>
    <span class="nx">bookshelfCoords</span><span class="p">[</span><span class="nx">bookshelfId</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;x1&#39;</span><span class="o">:</span> <span class="nx">x1</span><span class="p">,</span>
      <span class="s1">&#39;y1&#39;</span><span class="o">:</span> <span class="nx">y1</span><span class="p">,</span>
      <span class="s1">&#39;x2&#39;</span><span class="o">:</span> <span class="nx">x2</span><span class="p">,</span>
      <span class="s1">&#39;y2&#39;</span><span class="o">:</span> <span class="nx">y2</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nx">$</span><span class="p">(</span><span class="nx">bookshelfJSONId</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nv">value = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">bookshelfCoords</span><span class="p">)</span>


  <span class="nv">initBookshelves = </span><span class="nf">(bookshelves) -&gt;</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>TODO: position all of the bookshelves when the page loads
For each bookshelf create a draggable/resizeable element
That is, if the bookshelf has already been positioned
Otherwise, do nothing</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">bookshelves</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">bookshelf</span> <span class="k">in</span> <span class="nx">bookshelves</span>
      <span class="nx">do</span> <span class="nf">(bookshelf) -&gt;</span>
        <span class="nv">bookshelf = </span><span class="nx">bookshelf</span><span class="p">[</span><span class="s1">&#39;bookshelf&#39;</span><span class="p">]</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>initPlacementBox(bookshelf.id)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">bookshelf</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Defining this on the window class so it can be access from elsewhere</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nb">window</span><span class="p">.</span><span class="nv">updatePositions = </span><span class="o">-&gt;</span>
    <span class="nv">data = </span><span class="nx">$</span><span class="p">(</span><span class="nx">bookshelfJSONId</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>jQuery.post(&lsquo;/bookshelves/update_positions&rsquo;, data)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
      <span class="nv">type: </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
      <span class="nv">url: </span><span class="s1">&#39;/bookshelves/update_positions&#39;</span><span class="p">,</span>
      <span class="nv">data: </span><span class="p">{</span>
        <span class="nv">positions: </span><span class="nx">data</span>
      <span class="p">}</span>
    <span class="p">})</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>Listeners</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nx">availableBookshelves</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">handleClick</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>Initializer</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nx">initBookshelves</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">bookshelves_json</span><span class="p">)</span>
  <span class="nb">window</span><span class="p">.</span><span class="nv">initBookshelves = </span><span class="nx">initBookshelves</span>


<span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span> <span class="o">-&gt;</span>
  <span class="nx">Bookshelf</span><span class="p">()</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
